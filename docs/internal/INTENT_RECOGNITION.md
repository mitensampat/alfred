# Enhanced Intent Recognition System

## Overview

Alfred's intent recognition system has been enhanced with conversation context tracking, enabling multi-turn conversations and improved entity resolution.

## Key Features

### 1. Conversation Context Management

The system now tracks conversation history for each session:

- **Session-based tracking**: Each conversation gets a unique session ID
- **Automatic expiry**: Sessions expire after 1 hour of inactivity
- **Turn history**: Stores up to 10 recent turns per session
- **Entity tracking**: Remembers recent contacts, dates, platforms, and results

### 2. Enhanced Intent Actions

Extended from 7 to 11 actions:

- `generate`: Create a briefing, report, or draft
- `scan`: Scan for commitments or todos in messages
- `analyze`: Deep analysis of messages or calendar patterns
- `find`: Find specific items matching criteria
- `summarize`: Summarize a thread, meeting, or time period
- `check`: Run attention check or check for overdue items
- `list`: List existing items (commitments, drafts, etc.)
- **NEW** `update`: Update task or commitment status
- **NEW** `create`: Create new task or commitment
- **NEW** `delete`: Delete or cancel an item
- **NEW** `search`: Search across all data

### 3. Enhanced Intent Targets

Extended from 9 to 12 targets:

- `briefing`: Daily briefing with priorities and recommendations
- `calendar`: Calendar events and meeting briefings
- `messages`: Message threads and summaries
- `commitments`: Tracked commitments (I owe / they owe)
- `todos`: Todo items extracted from messages
- `drafts`: Draft messages generated by Alfred
- `attention`: Attention defense report (what to prioritize)
- `thread`: Specific message conversation
- `meeting`: Specific calendar event
- **NEW** `tasks`: Unified tasks (todos + commitments)
- **NEW** `contacts`: People and contacts
- **NEW** `preferences`: User preferences and settings

### 4. Context-Aware Prompts

Intent recognition now includes:

- **Recent conversation turns**: Last 3 turns with timestamps
- **Entity hints**: Recently mentioned contacts, dates, platforms
- **Result summaries**: What happened in previous turns

This enables queries like:
- "Show me commitments to Mona Gandhi" → "What about from last week?" → "Mark them as done"

### 5. Confidence Scoring

Clear confidence thresholds:

- **≥0.9**: Very clear intent, all parameters specified
- **0.7-0.9**: Clear action but some ambiguity in parameters
- **<0.7**: Ambiguous intent, triggers clarification

## Architecture

### Core Classes

#### `ConversationContext`
Manages all conversation sessions:
```swift
class ConversationContext {
    func getSession(for sessionId: String) -> ConversationSession
    func addTurn(sessionId: String, query: String, intent: UserIntent, result: IntentExecutionResult?)
    func getRecentContext(for sessionId: String, limit: Int = 3) -> [ConversationTurn]
}
```

#### `ConversationSession`
Tracks individual conversation:
```swift
class ConversationSession {
    let id: String
    private(set) var turns: [ConversationTurn]
    private(set) var entities: [String: EntityReference]

    func addTurn(query: String, intent: UserIntent, result: IntentExecutionResult?)
    func getRecentTurns(limit: Int) -> [ConversationTurn]
    func getEntity(key: String) -> EntityReference?
}
```

#### `ContextBuilder`
Formats context for prompts:
```swift
struct ContextBuilder {
    static func buildContextString(from turns: [ConversationTurn]) -> String
    static func buildEntityHints(from session: ConversationSession) -> String
}
```

#### `IntentRecognitionService`
Enhanced with session support:
```swift
class IntentRecognitionService {
    func recognizeIntent(_ query: String, sessionId: String = "default") async throws -> IntentRecognitionResponse
    func recordTurn(sessionId: String, query: String, intent: UserIntent, result: IntentExecutionResult?)
    func clearSession(_ sessionId: String)
}
```

## Usage

### API Endpoint

**POST** `/api/query`

**Request Body:**
```json
{
  "query": "Show me commitments to Mona Gandhi",
  "sessionId": "user-123-session"  // Optional, defaults to "default"
}
```

**Response:**
```json
{
  "type": "result",
  "query": "Show me commitments to Mona Gandhi",
  "response": "Found 3 commitments",
  "data": {...},
  "intent": {
    "action": "list",
    "target": "commitments",
    "confidence": 0.95
  },
  "suggestedFollowUps": [
    "Show me overdue commitments",
    "Scan for new commitments from this week"
  ],
  "sessionId": "user-123-session"
}
```

### Multi-Turn Example

```
Turn 1:
User: "Show me commitments to Mona Gandhi"
Alfred: "Found 3 commitments [lists them]"

Turn 2 (same session):
User: "What about from last week?"
Alfred: [Uses context to understand "Mona Gandhi" + "last week" filter]

Turn 3 (same session):
User: "Mark them as done"
Alfred: [Knows which commitments to update]
```

## Implementation Details

### Session Management

- **Auto-cleanup**: Expired sessions (>1 hour old) are automatically removed
- **Max turns**: Each session stores up to 10 recent turns
- **Entity storage**: Tracks:
  - `last_contact`: Most recent contact name
  - `last_date`: Most recent date mentioned
  - `last_platform`: Most recent messaging platform
  - `last_result_type`: Type of last execution result

### Prompt Enhancement

Context is injected into Claude prompts as:

```
Parse this user query into a structured intent:

Query: "What about from last week?"

Today's date: 2026-01-25T19:30:00Z

Recent conversation context:

1. User: "Show me commitments to Mona Gandhi"
   Intent: list → commitments (contact: Mona Gandhi)
   Result: Found 3 commitments (5m ago)

Entity context:
Recent contact: Mona Gandhi
Recent platform: whatsapp

IMPORTANT: Use conversation context to resolve references like:
- "that", "them", "those" → refer to entities from recent turns
- "yesterday", "last week" → use actual dates based on today
- Pronouns like "he", "she", "they" → refer to recent contacts
```

## Files Modified

### Core Models
- `Sources/Models/ConversationContext.swift` (NEW)
- `Sources/Models/Intent.swift` (Enhanced with new actions/targets)
- `Sources/GUI/Models/ConversationContext.swift` (NEW - GUI copy)
- `Sources/GUI/Models/Intent.swift` (Enhanced)

### Services
- `Sources/Services/IntentRecognitionService.swift` (Enhanced)
- `Sources/GUI/Services/IntentRecognitionService.swift` (Enhanced)
- `Sources/GUI/Services/HTTPServer.swift` (Enhanced)

## Testing

To test multi-turn conversations:

1. Start the server: `swift run alfred-app`
2. Send queries with same `sessionId`:

```bash
# Turn 1
curl -X POST http://localhost:8080/api/query \
  -H "X-API-Key: YOUR_PASSCODE" \
  -H "Content-Type: application/json" \
  -d '{"query": "Show me commitments to Mona Gandhi", "sessionId": "test-session"}'

# Turn 2 (context-aware)
curl -X POST http://localhost:8080/api/query \
  -H "X-API-Key: YOUR_PASSCODE" \
  -H "Content-Type: application/json" \
  -d '{"query": "What about from last week?", "sessionId": "test-session"}'
```

## Next Steps

Planned enhancements:

1. **Intent Handlers**: Implement execution handlers for new actions (update, create, delete, search)
2. **Validation & Fallbacks**: Add intent validation before execution
3. **Learning**: Track successful intent resolutions to improve confidence scoring
4. **Web UI**: Update web interface to maintain session IDs across queries
5. **Desktop App**: Add conversation history view to desktop app

## Benefits

1. **Natural conversations**: Users can ask follow-up questions without repeating context
2. **Reference resolution**: "that", "them", "yesterday" automatically resolved
3. **Better UX**: Fewer clarification questions needed
4. **Session isolation**: Multiple users can have separate conversations
5. **Automatic cleanup**: No manual session management needed
